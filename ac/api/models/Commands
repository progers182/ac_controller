<?php

require_once 'DbConn.php';
include_once 'Devices.php';

class Commands extends DbConn {
    private $command;
    private $device_id;

    public function read() {
        $query = 'SELECT * FROM `commands`;';

        $stmt = $this->conn->prepare($query);

        $stmt->execute();

        return $stmt;
    }

    public function read_single() {
        return $this->getDeviceId('172.0.0.1');
    }


    public function create($data) {
        $this->device_id = $this->getDeviceId($data->ip_address); // TODO add logic to check to see if ip is set. If not, prompt user to set name (which will create internal_id, set name, and ip_address in device_ids table
        $query = 'INSERT INTO `commands`
        SET update_time = CURRENT_TIMESTAMP(), command = :command, device_id = :device_id;
            ';

        $stmt = $this->conn->prepare($query);

        // clean
        $this->command = htmlspecialchars(strip_tags($data->command));

        // bind
        $stmt->execute([
            ':command' => $this->command,
            ':device_id' => $this->device_id[0]
        ]);
        return true;
    }

    public function getDeviceId($address) {
        $device = new Devices($this->conn);

        return $device->getDeviceId($address)->fetch(PDO::FETCH_NUM);
    }
}
